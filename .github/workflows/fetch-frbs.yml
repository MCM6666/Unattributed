name: Fetch FRBs

on:
  schedule:
    # Run daily at 12:00 UTC (before the 14:00 UTC post)
    - cron: '0 12 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch FRBSTATS catalogue
        run: |
          curl -fsSL "https://raw.githubusercontent.com/HeRTA/FRBSTATS/main/catalogue.csv" -o catalogue.csv

            - name: Debug downloaded CSV
        run: |
          ls -lh catalogue.csv
          python - <<'PY'
          import pathlib
          p = pathlib.Path("catalogue.csv")
          print("bytes:", p.stat().st_size)
          print("first 3 lines:")
          with p.open("r", encoding="utf-8", errors="replace") as f:
            for _ in range(3):
              print(f.readline().rstrip("\n"))
          PY

      - name: Convert CSV to JSON (robust)
        run: |
          python - <<'PY'
          import csv, json
          from datetime import datetime

          # Try to sniff delimiter (comma/semicolon/etc)
          with open("catalogue.csv", "r", encoding="utf-8", errors="replace") as f:
            sample = f.read(4096)
            f.seek(0)
            try:
              dialect = csv.Sniffer().sniff(sample, delimiters=[",",";","\t","|"])
            except Exception:
              dialect = csv.excel

            reader = csv.DictReader(f, dialect=dialect)

            frbs = []
            seen = set()

            def norm(s):
              return (s or "").strip()

            for row in reader:
              # handle varied header casing
              keys = {k.lower().strip(): k for k in row.keys() if k}
              def get(field):
                k = keys.get(field)
                return norm(row.get(k)) if k else ""

              frb = get("frb") or get("name")
              if not frb or frb in seen:
                continue

              seen.add(frb)
              frbs.append({
                "frb": frb,
                "utc": get("utc"),
                "telescope": get("telescope"),
                "ra": get("ra"),
                "dec": get("dec"),
                "dm": get("dm"),
                "width": get("width"),
                "snr": get("snr"),
                "fluence": get("fluence"),
                "frequency": get("frequency"),
              })

          # Sort newest-first by utc if present
          def parse_dt(s):
            s = (s or "").strip()
            if not s:
              return datetime(1970,1,1)
            # allow date-only
            if len(s) == 10 and s[4] == "-" and s[7] == "-":
              s = s + "T00:00:00"
            # best-effort parse
            try:
              return datetime.fromisoformat(s.replace("Z",""))
            except Exception:
              return datetime(1970,1,1)

          frbs.sort(key=lambda r: parse_dt(r.get("utc")), reverse=True)

          with open("frbs.json", "w", encoding="utf-8") as out:
            json.dump(frbs, out, indent=2)

          print("Processed unique FRBs:", len(frbs))
          PY


      - name: Commit if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add frbs.json
          git diff --staged --quiet || git commit -m "Update FRB catalogue $(date -u +%Y-%m-%d)"
          git push
