name: Fetch FRBs

on:
  schedule:
    - cron: '0 12 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Fetch FRBs from TNS
        run: |
          # TNS requires accepting cookies/terms - try the search API instead
          # First, let's see what we get
          curl -L -v "https://www.wis-tns.org/search?&discovered_period_value=1&discovered_period_units=years&objtype%5B%5D=130&num_page=500&format=csv" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            -o tns_search.csv 2>&1 | head -50
          
          echo "--- File contents (first 500 bytes) ---"
          head -c 500 tns_search.csv || true
          
          # Check if we got a CSV
          if head -1 tns_search.csv | grep -q "<!DOCTYPE\|<html"; then
            echo "Got HTML instead of CSV, TNS is blocking"
            
            # Fallback: use existing file or create minimal one
            if [ ! -f frbs.json ]; then
              echo "Creating placeholder frbs.json"
              echo '[{"name":"FRB 20240304A","date":"2024-03-04","source":"CHIME/FRB"}]' > frbs.json
            fi
            exit 0
          fi
          
          # Process CSV
          python3 << 'EOF'
          import csv
          import json
          
          frbs = []
          
          try:
              with open('tns_search.csv', 'r', encoding='utf-8', errors='ignore') as f:
                  content = f.read()
                  # Skip any metadata lines
                  lines = content.split('\n')
                  
                  # Find header line
                  start_idx = 0
                  for i, line in enumerate(lines):
                      if 'name' in line.lower() and ('ra' in line.lower() or 'disc' in line.lower()):
                          start_idx = i
                          break
                  
                  clean_csv = '\n'.join(lines[start_idx:])
                  
                  reader = csv.DictReader(clean_csv.splitlines())
                  for row in reader:
                      name = row.get('Name', row.get('name', ''))
                      if name:
                          frbs.append({
                              "name": f"FRB {name}" if not name.startswith('FRB') else name,
                              "date": row.get('Discovery Date (UT)', row.get('discoverydate', '')),
                              "ra": row.get('RA', row.get('ra', '')),
                              "dec": row.get('DEC', row.get('decl', '')),
                              "source": row.get('Reporting Group', 'TNS')
                          })
              
              if frbs:
                  frbs.sort(key=lambda x: x.get('date', ''), reverse=True)
                  with open('frbs.json', 'w') as f:
                      json.dump(frbs, f, indent=2)
                  print(f"Saved {len(frbs)} FRBs")
              else:
                  print("No FRBs found")
                  
          except Exception as e:
              print(f"Error: {e}")
          EOF
      
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add frbs.json || true
          git diff --staged --quiet || git commit -m "Update FRB data $(date +%Y-%m-%d)"
          git push
