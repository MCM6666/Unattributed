name: Fetch FRBs

on:
  schedule:
    - cron: '0 12 * * *'
  workflow_dispatch:

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Fetch FRBs from TNS
        run: |
          # Download TNS catalog with browser-like headers
          curl -L "https://www.wis-tns.org/system/files/tns_public_objects/tns_public_objects.csv.zip" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
            -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8" \
            -H "Accept-Language: en-US,en;q=0.5" \
            -o tns.zip
          
          # Check if download succeeded
          if [ ! -s tns.zip ]; then
            echo "Download failed or empty"
            exit 0
          fi
          
          # Unzip
          unzip -o tns.zip || { echo "Unzip failed"; exit 0; }
          
          # Extract FRBs
          python3 << 'EOF'
          import csv
          import json
          
          frbs = []
          
          try:
              with open('tns_public_objects.csv', 'r', encoding='utf-8', errors='ignore') as f:
                  # Skip the first line (metadata row)
                  first_line = f.readline()
                  
                  reader = csv.DictReader(f)
                  for row in reader:
                      # Check if it's an FRB
                      prefix = row.get('name_prefix', '').strip().upper()
                      if prefix == 'FRB':
                          frbs.append({
                              "name": f"FRB {row.get('name', '').strip()}",
                              "date": row.get('discoverydate', '').strip(),
                              "ra": row.get('ra', '').strip(),
                              "dec": row.get('decl', '').strip(),
                              "source": row.get('reporting_group/0/groupname', row.get('source_group/groupname', 'TNS')).strip() or 'TNS'
                          })
              
              if frbs:
                  # Sort by date descending
                  frbs.sort(key=lambda x: x.get('date', ''), reverse=True)
                  
                  with open('frbs.json', 'w') as f:
                      json.dump(frbs, f, indent=2)
                  
                  print(f"Saved {len(frbs)} FRBs")
              else:
                  print("No FRBs found in catalog")
                  
          except Exception as e:
              print(f"Error: {e}")
          EOF
      
      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add frbs.json || true
          git diff --staged --quiet || git commit -m "Update FRB data $(date +%Y-%m-%d)"
          git push || true
